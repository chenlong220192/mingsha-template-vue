pipeline {
    agent any
    
    environment {
        NODE_VERSION = '16'
        NPM_REGISTRY = 'https://registry.npmmirror.com'
        SONAR_HOST_URL = 'http://sonarqube:9000'
        SONAR_TOKEN = credentials('sonar-token')
        PROJECT_KEY = 'mingsha-ui'
        PROJECT_NAME = 'é¸£æ²™ç®¡ç†å¹³å°-å‰ç«¯'
    }
    
    parameters {
        choice(
            name: 'ANALYSIS_TYPE',
            choices: ['full', 'incremental'],
            description: 'åˆ†æç±»å‹'
        )
        booleanParam(
            name: 'FAIL_ON_QUALITY_GATE',
            defaultValue: true,
            description: 'è´¨é‡é—¨ç¦å¤±è´¥æ—¶åœæ­¢æ„å»º'
        )
    }
    
    stages {
        stage('ç¯å¢ƒå‡†å¤‡') {
            steps {
                script {
                    echo "ğŸ” å¼€å§‹ä»£ç è´¨é‡åˆ†æ"
                    echo "ğŸ“Š åˆ†æç±»å‹: ${ANALYSIS_TYPE}"
                    echo "ğŸš¨ è´¨é‡é—¨ç¦: ${FAIL_ON_QUALITY_GATE}"
                }
                
                // æ¸…ç†å·¥ä½œç©ºé—´
                cleanWs()
                
                // æ£€å‡ºä»£ç 
                checkout scm
                
                // åˆ‡æ¢åˆ°uiç›®å½•
                dir('ui') {
                    // è®¾ç½®Node.jsç¯å¢ƒ
                    sh """
                        echo "ğŸ“¦ å®‰è£… Node.js ${NODE_VERSION}"
                        curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
                        export NVM_DIR="\$HOME/.nvm"
                        [ -s "\$NVM_DIR/nvm.sh" ] && \. "\$NVM_DIR/nvm.sh"
                        nvm install ${NODE_VERSION}
                        nvm use ${NODE_VERSION}
                        node --version
                        npm --version
                    """
                }
            }
        }
        
        stage('ä¾èµ–å®‰è£…') {
            steps {
                dir('ui') {
                    sh """
                        export NVM_DIR="\$HOME/.nvm"
                        [ -s "\$NVM_DIR/nvm.sh" ] && \. "\$NVM_DIR/nvm.sh"
                        nvm use ${NODE_VERSION}
                        
                        echo "ğŸ“¦ å®‰è£…é¡¹ç›®ä¾èµ–"
                        npm config set registry ${NPM_REGISTRY}
                        npm install --verbose
                        
                        echo "ğŸ“¦ å®‰è£…SonarQube Scanner"
                        npm install -g sonarqube-scanner
                        
                        echo "ğŸ“‹ ä¾èµ–å®‰è£…å®Œæˆ"
                    """
                }
            }
        }
        
        stage('ä»£ç æ£€æŸ¥') {
            steps {
                dir('ui') {
                    sh """
                        export NVM_DIR="\$HOME/.nvm"
                        [ -s "\$NVM_DIR/nvm.sh" ] && \. "\$NVM_DIR/nvm.sh"
                        nvm use ${NODE_VERSION}
                        
                        echo "ğŸ” æ‰§è¡Œä»£ç æ£€æŸ¥"
                        npm run lint
                        
                        echo "âœ… ä»£ç æ£€æŸ¥é€šè¿‡"
                    """
                }
            }
        }
        
        stage('å•å…ƒæµ‹è¯•') {
            steps {
                dir('ui') {
                    sh """
                        export NVM_DIR="\$HOME/.nvm"
                        [ -s "\$NVM_DIR/nvm.sh" ] && \. "\$NVM_DIR/nvm.sh"
                        nvm use ${NODE_VERSION}
                        
                        echo "ğŸ§ª æ‰§è¡Œå•å…ƒæµ‹è¯•"
                        npm run test:unit -- --coverage
                        
                        echo "âœ… å•å…ƒæµ‹è¯•å®Œæˆ"
                    """
                }
            }
        }
        
        stage('æ„å»ºé¡¹ç›®') {
            steps {
                dir('ui') {
                    sh """
                        export NVM_DIR="\$HOME/.nvm"
                        [ -s "\$NVM_DIR/nvm.sh" ] && \. "\$NVM_DIR/nvm.sh"
                        nvm use ${NODE_VERSION}
                        
                        echo "ğŸ—ï¸ æ„å»ºé¡¹ç›®"
                        npm run build:prod
                        
                        echo "âœ… é¡¹ç›®æ„å»ºå®Œæˆ"
                    """
                }
            }
        }
        
        stage('SonarQubeåˆ†æ') {
            steps {
                dir('ui') {
                    script {
                        echo "ğŸ” å¼€å§‹SonarQubeä»£ç è´¨é‡åˆ†æ"
                        
                        // å‡†å¤‡SonarQubeé…ç½®æ–‡ä»¶
                        writeFile file: 'sonar-project.properties', text: """
                            sonar.projectKey=${PROJECT_KEY}
                            sonar.projectName=${PROJECT_NAME}
                            sonar.projectVersion=${env.BUILD_NUMBER}
                            sonar.sources=src
                            sonar.tests=src
                            sonar.exclusions=**/node_modules/**,**/dist/**,**/coverage/**,**/*.test.js,**/*.spec.js
                            sonar.test.inclusions=**/*.test.js,**/*.spec.js
                            sonar.javascript.lcov.reportPaths=coverage/lcov.info
                            sonar.coverage.exclusions=**/*.test.js,**/*.spec.js,**/node_modules/**
                            sonar.sourceEncoding=UTF-8
                            sonar.host.url=${SONAR_HOST_URL}
                            sonar.login=${SONAR_TOKEN}
                        """
                        
                        // æ‰§è¡ŒSonarQubeåˆ†æ
                        sh """
                            export NVM_DIR="\$HOME/.nvm"
                            [ -s "\$NVM_DIR/nvm.sh" ] && \. "\$NVM_DIR/nvm.sh"
                            nvm use ${NODE_VERSION}
                            
                            echo "ğŸ” æ‰§è¡ŒSonarQubeåˆ†æ"
                            sonar-scanner -Dsonar.projectKey=${PROJECT_KEY} \\
                                -Dsonar.sources=src \\
                                -Dsonar.tests=src \\
                                -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info \\
                                -Dsonar.host.url=${SONAR_HOST_URL} \\
                                -Dsonar.login=${SONAR_TOKEN}
                            
                            echo "âœ… SonarQubeåˆ†æå®Œæˆ"
                        """
                    }
                }
            }
        }
        
        stage('è´¨é‡é—¨ç¦æ£€æŸ¥') {
            when {
                expression { params.FAIL_ON_QUALITY_GATE == 'true' }
            }
            steps {
                script {
                    echo "ğŸš¨ æ£€æŸ¥è´¨é‡é—¨ç¦"
                    
                    // ç­‰å¾…SonarQubeåˆ†æå®Œæˆ
                    timeout(time: 5, unit: 'MINUTES') {
                        script {
                            def qualityGate = waitForQualityGate()
                            if (qualityGate.status != 'OK') {
                                error "è´¨é‡é—¨ç¦æœªé€šè¿‡: ${qualityGate.status}"
                            }
                        }
                    }
                    
                    echo "âœ… è´¨é‡é—¨ç¦æ£€æŸ¥é€šè¿‡"
                }
            }
        }
        
        stage('ç”ŸæˆæŠ¥å‘Š') {
            steps {
                script {
                    echo "ğŸ“Š ç”Ÿæˆè´¨é‡æŠ¥å‘Š"
                    
                    // å½’æ¡£æµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Š
                    dir('ui') {
                        archiveArtifacts artifacts: 'coverage/**/*', fingerprint: true
                    }
                    
                    // å‘å¸ƒSonarQubeæŠ¥å‘Š
                    publishHTML([
                        allowMissing: false,
                        alwaysLinkToLastBuild: true,
                        keepAll: true,
                        reportDir: 'ui/coverage/lcov-report',
                        reportFiles: 'index.html',
                        reportName: 'æµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Š'
                    ])
                    
                    echo "âœ… æŠ¥å‘Šç”Ÿæˆå®Œæˆ"
                }
            }
        }
        
        stage('æ¸…ç†') {
            always {
                script {
                    echo "ğŸ§¹ æ¸…ç†åˆ†æç¯å¢ƒ"
                    
                    // æ¸…ç†å·¥ä½œç©ºé—´
                    cleanWs()
                }
            }
        }
    }
    
    post {
        success {
            script {
                echo "ğŸ‰ ä»£ç è´¨é‡åˆ†ææˆåŠŸï¼"
                echo "ğŸ“Š åˆ†æä¿¡æ¯:"
                echo "   - é¡¹ç›®: ${PROJECT_NAME}"
                echo "   - æ„å»ºå·: ${env.BUILD_NUMBER}"
                echo "   - åˆ†æç±»å‹: ${ANALYSIS_TYPE}"
                echo "   - è´¨é‡é—¨ç¦: ${FAIL_ON_QUALITY_GATE}"
                echo "   - SonarQube: ${SONAR_HOST_URL}/dashboard?id=${PROJECT_KEY}"
                
                // å‘é€æˆåŠŸé€šçŸ¥
                emailext (
                    subject: "âœ… ä»£ç è´¨é‡åˆ†ææˆåŠŸ - ${PROJECT_NAME} #${env.BUILD_NUMBER}",
                    body: """
                        ä»£ç è´¨é‡åˆ†ææˆåŠŸï¼š
                        - é¡¹ç›®: ${PROJECT_NAME}
                        - æ„å»ºå·: ${env.BUILD_NUMBER}
                        - åˆ†æç±»å‹: ${ANALYSIS_TYPE}
                        - è´¨é‡é—¨ç¦: é€šè¿‡
                        
                        SonarQubeæŠ¥å‘Š: ${SONAR_HOST_URL}/dashboard?id=${PROJECT_KEY}
                        æ„å»ºæ—¥å¿—: ${env.BUILD_URL}console
                    """,
                    recipientProviders: [[$class: 'DevelopersRecipientProvider']]
                )
            }
        }
        
        failure {
            script {
                echo "âŒ ä»£ç è´¨é‡åˆ†æå¤±è´¥ï¼"
                echo "ğŸ” è¯·æ£€æŸ¥æ„å»ºæ—¥å¿—è·å–è¯¦ç»†ä¿¡æ¯"
                
                // å‘é€å¤±è´¥é€šçŸ¥
                emailext (
                    subject: "âŒ ä»£ç è´¨é‡åˆ†æå¤±è´¥ - ${PROJECT_NAME} #${env.BUILD_NUMBER}",
                    body: """
                        ä»£ç è´¨é‡åˆ†æå¤±è´¥ï¼š
                        - é¡¹ç›®: ${PROJECT_NAME}
                        - æ„å»ºå·: ${env.BUILD_NUMBER}
                        - åˆ†æç±»å‹: ${ANALYSIS_TYPE}
                        - å¤±è´¥åŸå› : è¯·æŸ¥çœ‹æ„å»ºæ—¥å¿—
                        
                        æ„å»ºæ—¥å¿—: ${env.BUILD_URL}console
                    """,
                    recipientProviders: [[$class: 'DevelopersRecipientProvider']]
                )
            }
        }
        
        always {
            script {
                echo "ğŸ“ˆ åˆ†æç»Ÿè®¡:"
                echo "   - åˆ†ææ—¶é•¿: ${currentBuild.durationString}"
                echo "   - åˆ†æç»“æœ: ${currentBuild.result}"
                echo "   - SonarQubeæŠ¥å‘Š: ${SONAR_HOST_URL}/dashboard?id=${PROJECT_KEY}"
            }
        }
    }
} 