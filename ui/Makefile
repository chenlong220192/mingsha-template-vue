#======================================================================
#
# example 'make init'
# example 'make package SKIP_TEST=true ENV=dev'
#
# author: mingsha
# date: 2025-07-11
#======================================================================

SHELL := /bin/bash -o pipefail

export BASE_PATH := $(shell dirname $(realpath $(lastword $(MAKEFILE_LIST))))

# ----------------------------- colors <-----------------------------
# é¢œè‰²å˜é‡ï¼ˆç”¨äºŽ printfï¼‰
RED=\033[31m
GREEN=\033[32m
YELLOW=\033[33m
BLUE=\033[34m
CYAN=\033[36m
BOLD=\033[1m
RESET=\033[0m

# Emojis and icons
ROCKET := ðŸš€
GEAR := âš™ï¸
TEST := ðŸ§ª
PACKAGE := ðŸ“¦
DOCKER := ðŸ³
HELM := ðŸŽ¯
CLEAN := ðŸ§¹
HELP := â“
INFO := â„¹ï¸
SUCCESS := âœ…
WARNING := âš ï¸
ERROR := âŒ
INSTALL := ðŸ“¥
RUN := â–¶ï¸
BUILD := ðŸ”¨
# ----------------------------- colors >-----------------------------

# ----------------------------- variables <-----------------------------
# unit test flag
ENV ?= dev
#
APPNAME ?= mingsha-template-vue-ui
VERSION ?= 1.0.0
PORT ?= 8000
HELM_NAMESPACE ?= mingsha
# ----------------------------- variables >-----------------------------

# ----------------------------- help <-----------------------------
.PHONY: help
help: ## $(HELP) æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
	@printf "${BOLD}${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${RESET}\n"
	@printf "${BOLD}${CYAN}â•‘                    ${ROCKET} é¸£æ²™å‰ç«¯æž„å»ºå·¥å…· ${ROCKET}                        â•‘${RESET}\n"
	@printf "${BOLD}${CYAN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}\n"
	@printf "\n"
	@printf "${BOLD}${YELLOW}%-8s:${RESET}\n" "ä½¿ç”¨æ–¹æ³•"
	@printf "  make <target> [ENV=environment]\n"
	@printf "\n"
	@printf "${BOLD}${YELLOW}%-8s:${RESET}\n" "çŽ¯å¢ƒå˜é‡"
	@printf "  ${GREEN}%-22s${RESET} %s\n" "ENV" "- çŽ¯å¢ƒé…ç½® (é»˜è®¤: local, å¯é€‰: dev, test, prod)"
	@printf "  ${GREEN}%-22s${RESET} %s\n" "APPNAME" "- åº”ç”¨åç§° (é»˜è®¤: mingsha-template-vue-ui)"
	@printf "  ${GREEN}%-22s${RESET} %s\n" "VERSION" "- ç‰ˆæœ¬å· (é»˜è®¤: 1.0.0)"
	@printf "  ${GREEN}%-22s${RESET} %s\n" "PORT" "- ç«¯å£å· (é»˜è®¤: 8000)"
	@printf "\n"
	@printf "${BOLD}${YELLOW}%-8s:${RESET}\n" "å¯ç”¨ç›®æ ‡"
	@awk 'BEGIN {FS = ":.*?## "; max=22} /^[a-zA-Z0-9_.-]+:.*?## / {cmd=$$1; desc=$$2; printf "  ${GREEN}%-*s${RESET} %s\n", max, cmd, desc}' max=22 $(MAKEFILE_LIST) | \
		sed 's/\$$(HELP)/$(HELP)/g' | sed 's/\$$(INSTALL)/$(INSTALL)/g' | sed 's/\$$(PACKAGE)/$(PACKAGE)/g' | sed 's/\$$(RUN)/$(RUN)/g' | sed 's/\$$(DOCKER)/$(DOCKER)/g' | sed 's/\$$(HELM)/$(HELM)/g'
	@printf "\n"
	@printf "${BOLD}${YELLOW}%-8s:${RESET}\n" "ç¤ºä¾‹"
	@printf "  ${GREEN}%-22s${RESET} %s\n" "make help" "${HELP} æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯"
	@printf "  ${GREEN}%-22s${RESET} %s\n" "make install" "${INSTALL} å®‰è£…ä¾èµ–"
	@printf "  ${GREEN}%-22s${RESET} %s\n" "make package ENV=dev" "${PACKAGE} æž„å»ºå¼€å‘çŽ¯å¢ƒåŒ…"
	@printf "  ${GREEN}%-22s${RESET} %s\n" "make docker.build ENV=prod" "${DOCKER} æž„å»ºç”Ÿäº§çŽ¯å¢ƒDockeré•œåƒ"
	@printf "  ${GREEN}%-22s${RESET} %s\n" "make helm.upgrade ENV=test" "${HELM} éƒ¨ç½²åˆ°æµ‹è¯•çŽ¯å¢ƒ"
	@printf "\n"
	@printf "${BOLD}${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${RESET}\n"
	@printf "${BOLD}${CYAN}â•‘                    ${SUCCESS} æž„å»ºæ„‰å¿«ï¼${SUCCESS}                              â•‘${RESET}\n"
	@printf "${BOLD}${CYAN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}\n"

.DEFAULT_GOAL := help
# ----------------------------- help >-----------------------------

# ----------------------------- local <-----------------------------
#
install: ## $(INSTALL) å®‰è£…ä¾èµ–
	@printf "${BLUE}${INSTALL} å®‰è£…ä¾èµ–...${RESET}\n"
	npm install --registry=https://registry.npmmirror.com
	@printf "${GREEN}${SUCCESS} ä¾èµ–å®‰è£…å®Œæˆï¼${RESET}\n"

#
package: ## $(PACKAGE) æž„å»ºç”Ÿäº§åŒ…
	@printf "${BLUE}${PACKAGE} æž„å»ºç”Ÿäº§åŒ… (çŽ¯å¢ƒ: ${ENV})...${RESET}\n"
	npm run build:prod
	@printf "${GREEN}${SUCCESS} æž„å»ºå®Œæˆï¼${RESET}\n"

#
run: ## $(RUN) å¯åŠ¨å¼€å‘æœåŠ¡å™¨
	@printf "${BLUE}${RUN} å¯åŠ¨å¼€å‘æœåŠ¡å™¨...${RESET}\n"
	npm run dev
# ----------------------------- local  >-----------------------------

# ----------------------------- docker <-----------------------------
#
docker.build: install package ## $(DOCKER) æž„å»ºDockeré•œåƒ
	@printf "${BLUE}${DOCKER} æž„å»ºDockeré•œåƒ (çŽ¯å¢ƒ: ${ENV})...${RESET}\n"
	sh ${BASE_PATH}/deploy/bin/docker/build.sh ${APPNAME} ${VERSION} ${ENV}
	@printf "${GREEN}${SUCCESS} Dockeré•œåƒæž„å»ºå®Œæˆï¼${RESET}\n"

#
docker.run: install package docker.build ## $(DOCKER) è¿è¡ŒDockerå®¹å™¨
	@printf "${BLUE}${DOCKER} è¿è¡ŒDockerå®¹å™¨...${RESET}\n"
	sh ${BASE_PATH}/deploy/bin/docker/run.sh ${APPNAME} ${VERSION} ${PORT} ${ENV}
	@printf "${GREEN}${SUCCESS} Dockerå®¹å™¨å¯åŠ¨å®Œæˆï¼${RESET}\n"
# ----------------------------- docker  >-----------------------------

# ----------------------------- helm <-----------------------------
#
helm.uninstall: ## $(HELM) å¸è½½Helméƒ¨ç½²
	@printf "${BLUE}${HELM} å¸è½½Helméƒ¨ç½²...${RESET}\n"
	sh ${BASE_PATH}/deploy/bin/helm/uninstall.sh $(APPNAME) $(HELM_NAMESPACE) $(ENV)
	@printf "${GREEN}${SUCCESS} Helméƒ¨ç½²å¸è½½å®Œæˆï¼${RESET}\n"

#
helm.upgrade: docker.build helm.uninstall ## $(HELM) å‡çº§Helméƒ¨ç½²
	@printf "${BLUE}${HELM} å‡çº§Helméƒ¨ç½² (çŽ¯å¢ƒ: ${ENV})...${RESET}\n"
	sh ${BASE_PATH}/deploy/bin/helm/install.sh $(APPNAME) $(HELM_NAMESPACE) $(ENV)
	@printf "${GREEN}${SUCCESS} Helméƒ¨ç½²å‡çº§å®Œæˆï¼${RESET}\n"
# ----------------------------- helm  >-----------------------------
