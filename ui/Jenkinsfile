pipeline {
    agent any

    environment {
        NODE_VERSION = '16'
        NPM_REGISTRY = 'https://registry.npmmirror.com'
        BUILD_ENV = "${params.BUILD_ENV ?: 'dev'}"
        SKIP_TESTS = "${params.SKIP_TESTS ?: 'false'}"
        DOCKER_IMAGE = 'mingsha-template-vue-ui'
        DOCKER_TAG = "${BUILD_ENV}-${BUILD_NUMBER}"
    }

    parameters {
        choice(
            name: 'BUILD_ENV',
            choices: ['dev', 'test', 'prod'],
            description: 'æ„å»ºç¯å¢ƒ'
        )
        booleanParam(
            name: 'SKIP_TESTS',
            defaultValue: false,
            description: 'è·³è¿‡æµ‹è¯•'
        )
        booleanParam(
            name: 'DOCKER_BUILD',
            defaultValue: false,
            description: 'æ„å»ºDockeré•œåƒ'
        )
        booleanParam(
            name: 'DEPLOY',
            defaultValue: false,
            description: 'è‡ªåŠ¨éƒ¨ç½²'
        )
    }

    stages {
        stage('ç¯å¢ƒå‡†å¤‡') {
            steps {
                script {
                    echo "ğŸš€ å¼€å§‹æ„å»ºå‰ç«¯é¡¹ç›® - ç¯å¢ƒ: ${BUILD_ENV}"
                    echo "ğŸ“¦ Node.js ç‰ˆæœ¬: ${NODE_VERSION}"
                    echo "ğŸ”§ è·³è¿‡æµ‹è¯•: ${SKIP_TESTS}"
                    echo "ğŸ³ æ„å»ºDocker: ${DOCKER_BUILD}"
                    echo "ğŸš€ è‡ªåŠ¨éƒ¨ç½²: ${DEPLOY}"
                }

                // æ¸…ç†å·¥ä½œç©ºé—´
                cleanWs()

                // æ£€å‡ºä»£ç 
                checkout scm

                // åˆ‡æ¢åˆ°uiç›®å½•
                dir('ui') {
                    // è®¾ç½®Node.jsç¯å¢ƒ
                    sh """
                        echo "ğŸ“¦ å®‰è£… Node.js ${NODE_VERSION}"
                        curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
                        export NVM_DIR="\$HOME/.nvm"
                        [ -s "\$NVM_DIR/nvm.sh" ] && \. "\$NVM_DIR/nvm.sh"
                        nvm install ${NODE_VERSION}
                        nvm use ${NODE_VERSION}
                        node --version
                        npm --version
                    """
                }
            }
        }

        stage('ä¾èµ–å®‰è£…') {
            steps {
                dir('ui') {
                    sh """
                        export NVM_DIR="\$HOME/.nvm"
                        [ -s "\$NVM_DIR/nvm.sh" ] && \. "\$NVM_DIR/nvm.sh"
                        nvm use ${NODE_VERSION}

                        echo "ğŸ“¦ å®‰è£…é¡¹ç›®ä¾èµ–"
                        npm config set registry ${NPM_REGISTRY}
                        npm install --verbose

                        echo "ğŸ“‹ ä¾èµ–å®‰è£…å®Œæˆ"
                        npm list --depth=0
                    """
                }
            }
        }

        stage('ä»£ç æ£€æŸ¥') {
            when {
                expression { params.SKIP_TESTS == 'false' }
            }
            steps {
                dir('ui') {
                    sh """
                        export NVM_DIR="\$HOME/.nvm"
                        [ -s "\$NVM_DIR/nvm.sh" ] && \. "\$NVM_DIR/nvm.sh"
                        nvm use ${NODE_VERSION}

                        echo "ğŸ” æ‰§è¡Œä»£ç æ£€æŸ¥"
                        npm run lint

                        echo "âœ… ä»£ç æ£€æŸ¥é€šè¿‡"
                    """
                }
            }
        }

        stage('å•å…ƒæµ‹è¯•') {
            when {
                expression { params.SKIP_TESTS == 'false' }
            }
            steps {
                dir('ui') {
                    sh """
                        export NVM_DIR="\$HOME/.nvm"
                        [ -s "\$NVM_DIR/nvm.sh" ] && \. "\$NVM_DIR/nvm.sh"
                        nvm use ${NODE_VERSION}

                        echo "ğŸ§ª æ‰§è¡Œå•å…ƒæµ‹è¯•"
                        npm run test:unit

                        echo "âœ… å•å…ƒæµ‹è¯•é€šè¿‡"
                    """
                }
            }
        }

        stage('æ„å»ºé¡¹ç›®') {
            steps {
                dir('ui') {
                    sh """
                        export NVM_DIR="\$HOME/.nvm"
                        [ -s "\$NVM_DIR/nvm.sh" ] && \. "\$NVM_DIR/nvm.sh"
                        nvm use ${NODE_VERSION}

                        echo "ğŸ—ï¸ å¼€å§‹æ„å»ºé¡¹ç›® - ç¯å¢ƒ: ${BUILD_ENV}"

                        if [ "${BUILD_ENV}" = "prod" ]; then
                            npm run build:prod
                        elif [ "${BUILD_ENV}" = "test" ]; then
                            npm run build:stage
                        else
                            npm run build:dev
                        fi

                        echo "âœ… é¡¹ç›®æ„å»ºå®Œæˆ"
                        ls -la dist/
                    """
                }
            }
        }

        stage('æ„å»ºDockeré•œåƒ') {
            when {
                expression { params.DOCKER_BUILD == 'true' }
            }
            steps {
                dir('ui') {
                    sh """
                        echo "ğŸ³ æ„å»ºDockeré•œåƒ"
                        docker build -t ${DOCKER_IMAGE}:${DOCKER_TAG} .
                        docker tag ${DOCKER_IMAGE}:${DOCKER_TAG} ${DOCKER_IMAGE}:${BUILD_ENV}

                        echo "ğŸ“‹ Dockeré•œåƒä¿¡æ¯"
                        docker images | grep ${DOCKER_IMAGE}
                    """
                }
            }
        }

        stage('éƒ¨ç½²') {
            when {
                expression { params.DEPLOY == 'true' }
            }
            steps {
                script {
                    echo "ğŸš€ å¼€å§‹éƒ¨ç½²åˆ° ${BUILD_ENV} ç¯å¢ƒ"

                    if (params.DOCKER_BUILD == 'true') {
                        // Dockeréƒ¨ç½²
                        sh """
                            echo "ğŸ³ ä½¿ç”¨Dockeréƒ¨ç½²"
                            docker stop mingsha-template-vue-ui-${BUILD_ENV} || true
                            docker rm mingsha-template-vue-ui-${BUILD_ENV} || true
                            docker run -d \\
                                --name mingsha-template-vue-ui-${BUILD_ENV} \\
                                -p 80:80 \\
                                -e NODE_ENV=${BUILD_ENV} \\
                                ${DOCKER_IMAGE}:${DOCKER_TAG}
                        """
                    } else {
                        // ç›´æ¥éƒ¨ç½²
                        sh """
                            echo "ğŸ“ ç›´æ¥éƒ¨ç½²æ„å»ºæ–‡ä»¶"
                            sudo mkdir -p /var/www/mingsha-template-vue-ui-${BUILD_ENV}
                            sudo cp -r ui/dist/* /var/www/mingsha-template-vue-ui-${BUILD_ENV}/
                            sudo chown -R www-data:www-data /var/www/mingsha-template-vue-ui-${BUILD_ENV}
                        """
                    }

                    echo "âœ… éƒ¨ç½²å®Œæˆ"
                }
            }
        }

        stage('æ¸…ç†') {
            always {
                script {
                    echo "ğŸ§¹ æ¸…ç†æ„å»ºç¯å¢ƒ"

                    // æ¸…ç†Dockeré•œåƒï¼ˆä¿ç•™æœ€æ–°ç‰ˆæœ¬ï¼‰
                    if (params.DOCKER_BUILD == 'true') {
                        sh """
                            docker images ${DOCKER_IMAGE} --format "table {{.Repository}}\\t{{.Tag}}\\t{{.CreatedAt}}" | grep -v "${DOCKER_TAG}" | grep -v "${BUILD_ENV}" | awk '{print \$1":"\$2}' | xargs -r docker rmi || true
                        """
                    }

                    // æ¸…ç†å·¥ä½œç©ºé—´
                    cleanWs()
                }
            }
        }
    }

    post {
        success {
            script {
                echo "ğŸ‰ æ„å»ºæˆåŠŸï¼"
                echo "ğŸ“Š æ„å»ºä¿¡æ¯:"
                echo "   - ç¯å¢ƒ: ${BUILD_ENV}"
                echo "   - æ„å»ºå·: ${BUILD_NUMBER}"
                echo "   - æ„å»ºæ—¶é—´: ${new Date().format('yyyy-MM-dd HH:mm:ss')}"

                if (params.DOCKER_BUILD == 'true') {
                    echo "ğŸ³ Dockeré•œåƒ: ${DOCKER_IMAGE}:${DOCKER_TAG}"
                }

                if (params.DEPLOY == 'true') {
                    echo "ğŸš€ å·²éƒ¨ç½²åˆ° ${BUILD_ENV} ç¯å¢ƒ"
                }
            }
        }

        failure {
            script {
                echo "âŒ æ„å»ºå¤±è´¥ï¼"
                echo "ğŸ” è¯·æ£€æŸ¥æ„å»ºæ—¥å¿—è·å–è¯¦ç»†ä¿¡æ¯"

                // å‘é€é€šçŸ¥
                emailext (
                    subject: "âŒ å‰ç«¯æ„å»ºå¤±è´¥ - ${env.JOB_NAME} #${env.BUILD_NUMBER}",
                    body: """
                        æ„å»ºå¤±è´¥è¯¦æƒ…ï¼š
                        - é¡¹ç›®: ${env.JOB_NAME}
                        - æ„å»ºå·: ${env.BUILD_NUMBER}
                        - ç¯å¢ƒ: ${BUILD_ENV}
                        - å¤±è´¥åŸå› : è¯·æŸ¥çœ‹æ„å»ºæ—¥å¿—

                        æ„å»ºæ—¥å¿—: ${env.BUILD_URL}console
                    """,
                    recipientProviders: [[$class: 'DevelopersRecipientProvider']]
                )
            }
        }

        always {
            script {
                echo "ğŸ“ˆ æ„å»ºç»Ÿè®¡:"
                echo "   - æ„å»ºæ—¶é•¿: ${currentBuild.durationString}"
                echo "   - æ„å»ºç»“æœ: ${currentBuild.result}"
            }
        }
    }
}
