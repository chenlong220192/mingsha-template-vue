# ğŸ† éƒ¨ç½²è„šæœ¬æœ€ä½³å®è·µ

## ğŸ¯ æ¦‚è¿°

æœ¬æ–‡æ¡£æ€»ç»“äº†åœ¨ä½¿ç”¨éƒ¨ç½²è„šæœ¬æ—¶çš„æœ€ä½³å®è·µï¼Œå¸®åŠ©æ‚¨æ„å»ºç¨³å®šã€å®‰å…¨ã€é«˜æ•ˆçš„éƒ¨ç½²æµç¨‹ã€‚

## ğŸ³ Docker æœ€ä½³å®è·µ

### é•œåƒæ„å»ºä¼˜åŒ–

#### 1. å¤šé˜¶æ®µæ„å»º

```dockerfile
# æ„å»ºé˜¶æ®µ
FROM maven:3.8.6-openjdk-17 AS builder
WORKDIR /app
COPY pom.xml .
COPY src ./src
RUN mvn clean package -DskipTests

# è¿è¡Œé˜¶æ®µ
FROM openjdk:17-jre-slim
WORKDIR /app
COPY --from=builder /app/target/*.jar app.jar
EXPOSE 8001
CMD ["java", "-jar", "app.jar"]
```

#### 2. é•œåƒæ ‡ç­¾ç­–ç•¥

```bash
# ä½¿ç”¨è¯­ä¹‰åŒ–ç‰ˆæœ¬
docker tag mingsha-template-vue:latest myregistry/mingsha-template-vue:v1.0.0

# ä½¿ç”¨ Git æäº¤å“ˆå¸Œ
docker tag mingsha-template-vue:latest myregistry/mingsha-template-vue:$(git rev-parse --short HEAD)

# ä½¿ç”¨ç¯å¢ƒæ ‡è¯†
docker tag mingsha-template-vue:latest myregistry/mingsha-template-vue:prod-v1.0.0
```

#### 3. å®‰å…¨æœ€ä½³å®è·µ

```dockerfile
# ä½¿ç”¨é root ç”¨æˆ·
RUN groupadd -r mingsha && useradd -r -g mingsha mingsha
USER mingsha

# åªå¤åˆ¶å¿…è¦æ–‡ä»¶
COPY --chown=mingsha:mingsha target/*.jar app.jar

# è®¾ç½®å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
  CMD curl -f http://localhost:8001/actuator/health || exit 1
```

### å®¹å™¨è¿è¡Œä¼˜åŒ–

#### 1. èµ„æºé™åˆ¶

```bash
# å†…å­˜å’Œ CPU é™åˆ¶
docker run \
  --memory=1g \
  --cpus=1 \
  --memory-swap=1g \
  mingsha-template-vue:latest

# ç½‘ç»œé™åˆ¶
docker run \
  --network=bridge \
  --dns=8.8.8.8 \
  mingsha-template-vue:latest
```

#### 2. æ•°æ®æŒä¹…åŒ–

```bash
# ä½¿ç”¨å‘½åå·
docker run \
  -v mingsha-logs:/app/logs \
  -v mingsha-config:/app/config \
  mingsha-template-vue:latest

# ä½¿ç”¨ç»‘å®šæŒ‚è½½
docker run \
  -v /host/logs:/app/logs \
  -v /host/config:/app/config:ro \
  mingsha-template-vue:latest
```

#### 3. ç¯å¢ƒå˜é‡ç®¡ç†

```bash
# ä½¿ç”¨ç¯å¢ƒæ–‡ä»¶
docker run \
  --env-file .env.prod \
  mingsha-template-vue:latest

# ä½¿ç”¨ Docker Secrets
docker run \
  --secret db_password \
  --secret redis_password \
  mingsha-template-vue:latest
```

## â˜¸ï¸ Kubernetes æœ€ä½³å®è·µ

### èµ„æºé…ç½®ä¼˜åŒ–

#### 1. èµ„æºè¯·æ±‚å’Œé™åˆ¶

```yaml
resources:
  requests:
    cpu: 500m
    memory: 512Mi
  limits:
    cpu: 1000m
    memory: 1Gi
```

#### 2. å¥åº·æ£€æŸ¥é…ç½®

```yaml
livenessProbe:
  httpGet:
    path: /actuator/health
    port: 8001
  initialDelaySeconds: 60
  periodSeconds: 30
  timeoutSeconds: 5
  failureThreshold: 3

readinessProbe:
  httpGet:
    path: /actuator/health
    port: 8001
  initialDelaySeconds: 30
  periodSeconds: 10
  timeoutSeconds: 3
  failureThreshold: 3
```

#### 3. å®‰å…¨ä¸Šä¸‹æ–‡

```yaml
securityContext:
  runAsNonRoot: true
  runAsUser: 1000
  readOnlyRootFilesystem: true
  capabilities:
    drop:
      - ALL
  allowPrivilegeEscalation: false
```

### éƒ¨ç½²ç­–ç•¥

#### 1. æ»šåŠ¨æ›´æ–°

```yaml
strategy:
  type: RollingUpdate
  rollingUpdate:
    maxSurge: 1
    maxUnavailable: 0
```

#### 2. è“ç»¿éƒ¨ç½²

```yaml
# ä½¿ç”¨ä¸¤ä¸ª Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mingsha-template-vue-blue
spec:
  replicas: 3
  selector:
    matchLabels:
      app: mingsha-template-vue
      version: blue
  template:
    metadata:
      labels:
        app: mingsha-template-vue
        version: blue
```

#### 3. é‡‘ä¸é›€éƒ¨ç½²

```yaml
# ä½¿ç”¨ Istio è¿›è¡Œæµé‡åˆ†å‰²
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: mingsha-template-vue
spec:
  hosts:
  - mingsha-template-vue
  http:
  - route:
    - destination:
        host: mingsha-template-vue
        subset: v1
      weight: 90
    - destination:
        host: mingsha-template-vue
        subset: v2
      weight: 10
```

## ğŸš€ åº”ç”¨éƒ¨ç½²æœ€ä½³å®è·µ

### JVM è°ƒä¼˜

#### 1. å†…å­˜é…ç½®

```bash
# ç”Ÿäº§ç¯å¢ƒ JVM å‚æ•°
-server
-Xms2g
-Xmx2g
-Xmn1g
-XX:MetaspaceSize=128m
-XX:MaxMetaspaceSize=512m
-XX:+UseG1GC
-XX:MaxGCPauseMillis=200
-XX:G1HeapRegionSize=16m
-XX:+UnlockExperimentalVMOptions
-XX:+UseZGC
```

#### 2. GC ä¼˜åŒ–

```bash
# G1GC é…ç½®
-XX:+UseG1GC
-XX:G1NewSizePercent=30
-XX:G1MaxNewSizePercent=40
-XX:G1HeapRegionSize=16m
-XX:G1MixedGCCountTarget=8
-XX:G1MixedGCLiveThresholdPercent=85
```

#### 3. ç›‘æ§é…ç½®

```bash
# JMX ç›‘æ§
-Dcom.sun.management.jmxremote
-Dcom.sun.management.jmxremote.port=9999
-Dcom.sun.management.jmxremote.authenticate=false
-Dcom.sun.management.jmxremote.ssl=false
```

### æ—¥å¿—ç®¡ç†

#### 1. æ—¥å¿—é…ç½®

```xml
<!-- logback-spring.xml -->
<configuration>
  <appender name="FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
    <file>logs/mingsha-template-vue.log</file>
    <rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
      <fileNamePattern>logs/mingsha-template-vue.%d{yyyy-MM-dd}.%i.log</fileNamePattern>
      <timeBasedFileNamingAndTriggeringPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedFNATP">
        <maxFileSize>100MB</maxFileSize>
      </timeBasedFileNamingAndTriggeringPolicy>
      <maxHistory>30</maxHistory>
    </rollingPolicy>
  </appender>
</configuration>
```

#### 2. æ—¥å¿—è½®è½¬

```bash
# ä½¿ç”¨ logrotate
/opt/mingsha-template-vue/logs/*.log {
    daily
    rotate 30
    compress
    delaycompress
    missingok
    notifempty
    create 644 mingsha mingsha
    postrotate
        kill -HUP $(cat /opt/mingsha-template-vue/mingsha-template-vue-boot.pid)
    endscript
}
```

## ğŸ”’ å®‰å…¨æœ€ä½³å®è·µ

### é•œåƒå®‰å…¨

#### 1. é•œåƒæ‰«æ

```bash
# ä½¿ç”¨ Trivy æ‰«æé•œåƒ
trivy image mingsha-template-vue:latest

# ä½¿ç”¨ Snyk æ‰«æ
snyk container test mingsha-template-vue:latest
```

#### 2. é•œåƒç­¾å

```bash
# ä½¿ç”¨ Docker Content Trust
export DOCKER_CONTENT_TRUST=1
docker push myregistry/mingsha-template-vue:latest
```

#### 3. æœ€å°åŒ–æ”»å‡»é¢

```dockerfile
# ä½¿ç”¨ distroless é•œåƒ
FROM gcr.io/distroless/java:17
COPY target/*.jar app.jar
CMD ["app.jar"]
```

### ç½‘ç»œå®‰å…¨

#### 1. ç½‘ç»œç­–ç•¥

```yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: mingsha-template-vue-network-policy
spec:
  podSelector:
    matchLabels:
      app: mingsha-template-vue
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          name: ingress-nginx
    ports:
    - protocol: TCP
      port: 8001
  egress:
  - to:
    - namespaceSelector:
        matchLabels:
          name: database
    ports:
    - protocol: TCP
      port: 3306
```

#### 2. TLS é…ç½®

```yaml
apiVersion: v1
kind: Secret
metadata:
  name: mingsha-template-vue-tls
type: kubernetes.io/tls
data:
  tls.crt: <base64-encoded-cert>
  tls.key: <base64-encoded-key>
```

## ğŸ“Š ç›‘æ§å’Œå¯è§‚æµ‹æ€§

### åº”ç”¨ç›‘æ§

#### 1. æŒ‡æ ‡æ”¶é›†

```yaml
# Prometheus é…ç½®
apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-config
data:
  prometheus.yml: |
    global:
      scrape_interval: 15s
    scrape_configs:
    - job_name: 'mingsha-template-vue'
      static_configs:
      - targets: ['mingsha-template-vue:8001']
      metrics_path: '/actuator/prometheus'
```

#### 2. æ—¥å¿—èšåˆ

```yaml
# Fluentd é…ç½®
apiVersion: v1
kind: ConfigMap
metadata:
  name: fluentd-config
data:
  fluent.conf: |
    <source>
      @type tail
      path /var/log/containers/mingsha-template-vue-*.log
      pos_file /var/log/mingsha-template-vue.log.pos
      tag mingsha-template-vue
      read_from_head true
      <parse>
        @type json
        time_key time
        time_format %Y-%m-%dT%H:%M:%S.%NZ
      </parse>
    </source>
```

#### 3. åˆ†å¸ƒå¼è¿½è¸ª

```yaml
# Jaeger é…ç½®
apiVersion: apps/v1
kind: Deployment
metadata:
  name: jaeger
spec:
  template:
    spec:
      containers:
      - name: jaeger
        image: jaegertracing/all-in-one:latest
        ports:
        - containerPort: 16686
        - containerPort: 14268
```

## ğŸ”„ CI/CD æœ€ä½³å®è·µ

### è‡ªåŠ¨åŒ–éƒ¨ç½²

#### 1. å¤šç¯å¢ƒéƒ¨ç½²

```yaml
# GitLab CI/CD
stages:
  - build
  - test
  - deploy

build:
  stage: build
  script:
    - docker build -t mingsha-template-vue:$CI_COMMIT_SHA .
    - docker push registry.example.com/mingsha-template-vue:$CI_COMMIT_SHA

deploy-dev:
  stage: deploy
  script:
    - helm upgrade --install mingsha-template-vue-dev ./helm-chart
  environment:
    name: development
  only:
    - develop

deploy-prod:
  stage: deploy
  script:
    - helm upgrade --install mingsha-template-vue-prod ./helm-chart
  environment:
    name: production
  only:
    - master
  when: manual
```

#### 2. éƒ¨ç½²éªŒè¯

```bash
# å¥åº·æ£€æŸ¥è„šæœ¬
#!/bin/bash
set -e

# ç­‰å¾…åº”ç”¨å¯åŠ¨
sleep 30

# å¥åº·æ£€æŸ¥
curl -f http://localhost:8001/actuator/health

# åŠŸèƒ½æµ‹è¯•
curl -f http://localhost:8001/api/test

# æ€§èƒ½æµ‹è¯•
ab -n 100 -c 10 http://localhost:8001/api/test
```

#### 3. å›æ»šç­–ç•¥

```bash
# è‡ªåŠ¨å›æ»šè„šæœ¬
#!/bin/bash

# æ£€æŸ¥éƒ¨ç½²çŠ¶æ€
if ! kubectl rollout status deployment/mingsha-template-vue -n production --timeout=300s; then
    echo "éƒ¨ç½²å¤±è´¥ï¼Œå¼€å§‹å›æ»š..."
    kubectl rollout undo deployment/mingsha-template-vue -n production
    kubectl rollout status deployment/mingsha-template-vue -n production
    exit 1
fi
```

## ğŸ“‹ æ£€æŸ¥æ¸…å•

### éƒ¨ç½²å‰æ£€æŸ¥

- [ ] ä»£ç å·²é€šè¿‡æ‰€æœ‰æµ‹è¯•
- [ ] å®‰å…¨æ‰«æé€šè¿‡
- [ ] æ€§èƒ½æµ‹è¯•é€šè¿‡
- [ ] é…ç½®æ–‡ä»¶å·²æ›´æ–°
- [ ] æ•°æ®åº“è¿ç§»è„šæœ¬å·²å‡†å¤‡
- [ ] å¤‡ä»½ç­–ç•¥å·²ç¡®è®¤
- [ ] å›æ»šè®¡åˆ’å·²å‡†å¤‡
- [ ] ç›‘æ§å‘Šè­¦å·²é…ç½®

### éƒ¨ç½²ä¸­æ£€æŸ¥

- [ ] éƒ¨ç½²è¿›åº¦ç›‘æ§
- [ ] åº”ç”¨å¯åŠ¨çŠ¶æ€
- [ ] å¥åº·æ£€æŸ¥é€šè¿‡
- [ ] æ•°æ®åº“è¿æ¥æ­£å¸¸
- [ ] ç¼“å­˜è¿æ¥æ­£å¸¸
- [ ] æ—¥å¿—è¾“å‡ºæ­£å¸¸
- [ ] æ€§èƒ½æŒ‡æ ‡æ­£å¸¸

### éƒ¨ç½²åæ£€æŸ¥

- [ ] åŠŸèƒ½æµ‹è¯•é€šè¿‡
- [ ] æ€§èƒ½æµ‹è¯•é€šè¿‡
- [ ] å®‰å…¨æµ‹è¯•é€šè¿‡
- [ ] ç›‘æ§å‘Šè­¦æ­£å¸¸
- [ ] æ—¥å¿—æ”¶é›†æ­£å¸¸
- [ ] å¤‡ä»½éªŒè¯é€šè¿‡
- [ ] æ–‡æ¡£æ›´æ–°å®Œæˆ

## ğŸš¨ å¸¸è§é—®é¢˜è§£å†³

### æ€§èƒ½é—®é¢˜

1. **å†…å­˜æ³„æ¼**
   ```bash
   # ç”Ÿæˆå †è½¬å‚¨
   jmap -dump:format=b,file=heap.hprof <pid>
   
   # åˆ†æå †è½¬å‚¨
   jhat heap.hprof
   ```

2. **GC é—®é¢˜**
   ```bash
   # æŸ¥çœ‹ GC ç»Ÿè®¡
   jstat -gc <pid> 1000
   
   # æŸ¥çœ‹ GC æ—¥å¿—
   tail -f gc.log
   ```

3. **çº¿ç¨‹é—®é¢˜**
   ```bash
   # æŸ¥çœ‹çº¿ç¨‹çŠ¶æ€
   jstack <pid>
   
   # æŸ¥çœ‹çº¿ç¨‹ CPU ä½¿ç”¨
   top -H -p <pid>
   ```

### ç½‘ç»œé—®é¢˜

1. **è¿æ¥è¶…æ—¶**
   ```bash
   # æ£€æŸ¥ç½‘ç»œè¿é€šæ€§
   telnet <host> <port>
   
   # æ£€æŸ¥ DNS è§£æ
   nslookup <host>
   ```

2. **ç«¯å£å†²çª**
   ```bash
   # æ£€æŸ¥ç«¯å£å ç”¨
   netstat -tlnp | grep <port>
   
   # æ£€æŸ¥è¿›ç¨‹
   lsof -i :<port>
   ```

## ğŸ“ æ€»ç»“

éµå¾ªè¿™äº›æœ€ä½³å®è·µå¯ä»¥å¸®åŠ©æ‚¨ï¼š

1. **æé«˜éƒ¨ç½²æ•ˆç‡**: è‡ªåŠ¨åŒ–éƒ¨ç½²æµç¨‹ï¼Œå‡å°‘äººå·¥é”™è¯¯
2. **å¢å¼ºå®‰å…¨æ€§**: å¤šå±‚å®‰å…¨é˜²æŠ¤ï¼Œä¿æŠ¤åº”ç”¨å’Œæ•°æ®
3. **ä¼˜åŒ–æ€§èƒ½**: åˆç†çš„èµ„æºé…ç½®å’Œè°ƒä¼˜
4. **æå‡å¯é æ€§**: å®Œå–„çš„ç›‘æ§å’Œæ•…éšœå¤„ç†æœºåˆ¶
5. **ç®€åŒ–ç»´æŠ¤**: æ ‡å‡†åŒ–çš„éƒ¨ç½²å’Œç®¡ç†æµç¨‹

è®°ä½ï¼Œæœ€ä½³å®è·µæ˜¯æŒç»­æ”¹è¿›çš„è¿‡ç¨‹ï¼Œéœ€è¦æ ¹æ®å®é™…æƒ…å†µä¸æ–­è°ƒæ•´å’Œä¼˜åŒ–ã€‚ 